<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1.0" />
  <meta name="description" content="Watch live sports events with Scooby Bruh Live" />
  <title>Scooby Bruh Live</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body { 
      background: #0d0d0d; 
      color: #fff; 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
    }
    main { flex: 1; }
    .platform-card { 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      background: linear-gradient(145deg, #181818, #2a2a2a); 
      border-radius: 0.75rem; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
      text-align: center; 
    }
    .platform-card:hover { 
      transform: translateY(-6px) scale(1.04); 
      box-shadow: 0 12px 25px rgba(220,38,38,0.25), 0 6px 15px rgba(0,0,0,0.4); 
    }
    .gradient-text { 
      background: linear-gradient(45deg, #ff3131, #ffb347, #ff3131); 
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent; 
      text-shadow: 0 2px 5px rgba(255, 49, 49, 0.3); 
    }
    footer { 
      background: #141414; 
      padding: 2rem 1rem; 
      text-align: center; 
      margin-top: auto; 
      border-top: 1px solid #222; 
    }
    .logo { 
      width: 42px; 
      height: 42px; 
      border-radius: 8px; 
      background: linear-gradient(145deg, #1e3a8a, #dc2626); 
      padding: 6px; 
    }
    .loading { 
      display: inline-block; 
      width: 20px; 
      height: 20px; 
      border: 3px solid #f3f3f3; 
      border-top: 3px solid #dc2626; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }

    /* Custom Popup Styles */
    .popup-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.85); 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      backdrop-filter: blur(5px); 
    }
    .popup-container { 
      background: linear-gradient(145deg, #1a1a1a, #2d2d2d); 
      border-radius: 1rem; 
      padding: 2rem; 
      max-width: 400px; 
      width: 90%; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.6); 
      border: 1px solid #333; 
    }
    .popup-title { 
      font-size: 1.5rem; 
      font-weight: bold; 
      margin-bottom: 1rem; 
      text-align: center; 
      background: linear-gradient(45deg, #ff3131, #ffb347); 
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent; 
    }
    .popup-input { 
      width: 100%; 
      padding: 0.75rem; 
      border-radius: 0.5rem; 
      border: 1px solid #444; 
      background: #222; 
      color: #fff; 
      font-size: 1rem; 
      margin-bottom: 1rem; 
    }
    .popup-input:focus { 
      outline: none; 
      border-color: #dc2626; 
      box-shadow: 0 0 0 2px rgba(220,38,38,0.2); 
    }
    .popup-button { 
      width: 100%; 
      padding: 0.75rem; 
      background: linear-gradient(45deg, #dc2626, #ff4444); 
      color: white; 
      border: none; 
      border-radius: 0.5rem; 
      font-size: 1rem; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
    }
    .popup-button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(220,38,38,0.4); 
    }
    .popup-button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="bg-black sticky top-0 z-50 shadow-md">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Superman_shield.svg/640px-Superman_shield.svg.png" class="logo" />
        <h1 class="text-xl font-bold gradient-text">Scooby Bruh üê∂</h1>
      </div>
      <div class="text-sm text-gray-400">
        <i class="fas fa-tv mr-1"></i>
        Live Sports
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <div id="platforms-container" class="text-center">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-400">Loading sports platforms...</p>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <a href="https://t.me/+u8PDYVT92MA3MTg9" target="_blank" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-full transition-colors">
      <i class="fab fa-telegram-plane text-lg mr-2"></i>
      <span>Join Telegram</span>
    </a>
    <p class="text-gray-400 text-sm mt-4">¬© 2024 Scooby Bruh Live. Watch responsibly.</p>
  </footer>

  <!-- Custom Name Popup -->
  <div id="name-popup" class="popup-overlay">
    <div class="popup-container">
      <h2 class="popup-title">Welcome to Scooby Bruh! üê∂</h2>
      <p class="text-gray-300 text-center mb-4">Please enter your name to continue</p>
      <input type="text" id="name-input" class="popup-input" placeholder="Enter your name..." maxlength="50">
      <button id="name-submit" class="popup-button">
        <i class="fas fa-play mr-2"></i>Start Watching
      </button>
    </div>
  </div>

  <script>
    // Telegram Configuration - These will be loaded from your API endpoint
    let TELEGRAM_BOT_TOKEN = "";
    let TELEGRAM_CHAT_ID = "";

    // Load configuration from your secure API endpoint
    async function loadTelegramConfig() {
      try {
        const response = await fetch('/api/telegram-config');
        const config = await response.json();
        TELEGRAM_BOT_TOKEN = config.botToken;
        TELEGRAM_CHAT_ID = config.chatId;
      } catch (error) {
        console.warn('Could not load Telegram configuration');
      }
    }

    // Global variables for tracking
    let userName = "";
    let userMessageId = null;
    let watchHistory = [];
    let currentStreamName = "";
    let streamStartTime = null;
    let watchSeconds = 0;
    let isWatching = false;
    let liveViewers = new Set();
    let totalViews = 0;
    let adClicks = [];
    let externalPlayerClicks = [];
    let clickHistory = [];

    // Function to get current time in Indian timezone
    function getIndianTime() {
        const options = {
            timeZone: 'Asia/Kolkata',
            hour12: true,
            hour: 'numeric',
            minute: 'numeric',
            second: 'numeric',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        };
        return new Date().toLocaleString('en-US', options);
    }

    // Initialize user data in Telegram with a single message
    function initializeUserData() {
        const userAgent = navigator.userAgent;
        const currentTime = getIndianTime();
        const message = `üö® New Viewer:\nName: ${userName}\nDevice: ${userAgent}\nLogin Time: ${currentTime}\n\nüì∫ Watch History: None\n‚è±Ô∏è Total Watch Time: 00:00:00`;

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    userMessageId = data.result.message_id;
                    console.log("User data initialized in Telegram with message ID:", userMessageId);
                }
            })
            .catch(error => console.error("Error sending to Telegram:", error));
    }

    // Update user data in Telegram
    function updateUserTelegramMessage() {
        if (!userMessageId) return;

        let historyText = clickHistory.length > 0 ? '\n\nüì∫ Click History:' : '\n\nüì∫ Click History: None';

        if (clickHistory.length > 0) {
            clickHistory.slice(-5).forEach((entry, index) => {
                const icon = entry.type === 'external' ? 'üîó' : 'üì∫';
                historyText += `\n${icon} ${entry.name} (${entry.time})`;
            });
        }

        const currentTime = getIndianTime();
        let statusText = isWatching ? `\n\nüü¢ Currently watching: ${currentStreamName}` : `\n\nüî¥ Browsing platforms`;

        const userAgent = navigator.userAgent;
        const message = `üö® Stream Viewer:\nName: ${userName}\nDevice: ${userAgent}\nLogin Time: ${currentTime}${statusText}${historyText}`;

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageText?chat_id=${TELEGRAM_CHAT_ID}&message_id=${userMessageId}&text=${encodeURIComponent(message)}`;

        fetch(url).catch(error => console.error("Error updating Telegram message:", error));
    }

    // Track clicks
    function handlePlatformClick(platformName, linkType) {
        if (!userName) {
            showNamePopup();
            return false;
        }

        clickHistory.push({
            name: platformName,
            type: linkType,
            time: getIndianTime()
        });

        if (linkType === 'external') {
            externalPlayerClicks.push({
                player: platformName,
                time: getIndianTime()
            });
        }

        updateUserTelegramMessage();
        return true;
    }

    // Show name popup (always shows, no localStorage check)
    function showNamePopup() {
        const popup = document.getElementById('name-popup');
        const input = document.getElementById('name-input');
        
        popup.style.display = 'flex';
        input.focus();

        // Handle name submission
        function submitName() {
            const name = input.value.trim();
            if (name !== "") {
                userName = name;
                popup.style.display = 'none';
                liveViewers.add(userName);
                initializeUserData();
                totalViews++;
            }
        }

        document.getElementById('name-submit').onclick = submitName;
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitName();
        });
    }

    // Initialize on page load
    async function initializeTelegramTracking() {
        // Load Telegram configuration first
        await loadTelegramConfig();
        
        // Always show name popup (no localStorage check)
        showNamePopup();
        totalViews++;
    }

    // Handle visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            if (userName) {
                liveViewers.add(userName);
            }
        } else {
            if (userName) {
                liveViewers.delete(userName);
            }
        }
        updateUserTelegramMessage();
    });

    // Handle page unload
    window.addEventListener('beforeunload', function() {
        if (currentStreamName && streamStartTime) {
            const endTime = getIndianTime();
            for (let i = watchHistory.length - 1; i >= 0; i--) {
                if (watchHistory[i].stream === currentStreamName && !watchHistory[i].endTime) {
                    watchHistory[i].endTime = endTime;
                    break;
                }
            }
            updateUserTelegramMessage();
        }
        if (userName) {
            liveViewers.delete(userName);
        }
    });

    // Load platforms data
    const container = document.getElementById('platforms-container');

    fetch(`https://scoobystreams.vercel.app/ascooby.json?nocache=${Date.now()}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = `
            <div class="text-center py-20">
              <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
              <h2 class="text-xl text-gray-300 mb-2">No platforms available</h2>
              <p class="text-gray-500">Please try again later.</p>
            </div>`;
          return;
        }

        // Featured banners
        const featuredMatches = data.filter(item => item.featured === true);
        let featuredHTML = '';
        
        if (featuredMatches.length > 0) {
          featuredHTML = `
            <section class="mb-8 space-y-6">
              <h2 class="text-2xl font-bold text-center mb-6">
                <i class="fas fa-star text-yellow-500 mr-2"></i>
                Featured Matches
              </h2>
              ${featuredMatches.map(featured => {
                let linkUrl = '';
                if (featured.linkType === "external") {
                  linkUrl = featured.link;
                } else if (featured.linkType === "multi") {
                  linkUrl = `match.html?name=${encodeURIComponent(featured.name)}`;
                } else {
                  linkUrl = `play.html?name=${encodeURIComponent(featured.name)}`;
                }
                return `
                  <a href="${linkUrl}" 
                     ${featured.linkType === "external" ? 'target="_blank" rel="noopener noreferrer"' : ''} 
                     onclick="return handlePlatformClick('${featured.name}', '${featured.linkType}')"
                     class="block bg-gradient-to-r from-red-700 to-orange-600 rounded-lg shadow-lg overflow-hidden hover:scale-[1.02] transition-transform">
                    <div class="flex flex-col sm:flex-row">
                      <div class="w-full sm:w-1/3 bg-black flex items-center justify-center p-4">
                        <img src="${featured.image}" 
                             alt="${featured.name}" 
                             class="w-full h-32 sm:h-24 object-contain"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNjY2NjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZTwvdGV4dD48L3N2Zz4='">
                      </div>
                      <div class="flex-1 p-4 flex flex-col justify-center">
                        <h3 class="text-xl font-bold text-white mb-2">${featured.name}</h3>
                        <p class="text-gray-300">üî¥ LIVE - Click to watch now</p>
                        <div class="mt-3 flex items-center text-sm text-gray-400">
                          <i class="fas fa-play-circle mr-2"></i>
                          Watch Live Stream
                        </div>
                      </div>
                    </div>
                  </a>
                `;
              }).join('')}
            </section>
          `;
        }

        // Regular platform cards
        const regularPlatforms = data.filter(item => !item.featured);
        let platformsHTML = '';
        
        if (regularPlatforms.length > 0) {
          platformsHTML = `
            <section>
              <h2 class="text-2xl font-bold text-center mb-6">
                <i class="fas fa-tv mr-2"></i>
                All Platforms
              </h2>
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 justify-items-center">
                ${regularPlatforms.map(platform => {
                  let linkUrl = '';
                  if (platform.linkType === "external") {
                    linkUrl = platform.link;
                  } else if (platform.linkType === "multi") {
                    linkUrl = `match.html?name=${encodeURIComponent(platform.name)}`;
                  } else {
                    linkUrl = `play.html?name=${encodeURIComponent(platform.name)}`;
                  }
                  return `
                    <article class="platform-card w-full max-w-[160px] sm:max-w-[180px]">
                      <div class="relative aspect-video bg-black flex items-center justify-center p-2">
                        <img src="${platform.image}" 
                             alt="${platform.name}" 
                             class="max-w-full max-h-full object-contain"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNjY2NjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5UVjwvdGV4dD48L3N2Zz4='">
                      </div>
                      <div class="p-3 space-y-2">
                        <h3 class="text-sm font-semibold text-gray-100 truncate">${platform.name}</h3>
                        <a href="${linkUrl}" 
                           ${platform.linkType === "external" ? 'target="_blank" rel="noopener noreferrer"' : ''} 
                           onclick="return handlePlatformClick('${platform.name}', '${platform.linkType}')"
                           class="w-full inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-3 py-1.5 rounded-md text-xs transition-colors">
                          <i class="fas fa-play text-xs"></i>
                          <span>Watch</span>
                        </a>
                      </div>
                    </article>
                  `;
                }).join('')}
              </div>
            </section>
          `;
        }

        container.innerHTML = featuredHTML + platformsHTML;
      })
      .catch(error => {
        console.error('Error loading data:', error);
        container.innerHTML = `
          <div class="text-center py-20">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h2 class="text-xl text-gray-300 mb-2">Error loading platforms</h2>
            <p class="text-gray-500 mb-4">Unable to fetch sports data. Please check your connection.</p>
            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
              <i class="fas fa-refresh mr-2"></i>
              Try Again
            </button>
          </div>`;
    // Initialize on page load
    document.addEventListener("DOMContentLoaded", initializeTelegramTracking);
</body>
</html>